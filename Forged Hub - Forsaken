-- BOOT RAYFIELD
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "Forged Hub - Forsaken",
   Icon = "anvil",
   LoadingTitle = "Forged Hub",
   LoadingSubtitle = "Loading...",
   ShowText = "Forged Hub",
   Theme = "DarkBlue",

   ToggleUIKeybind = "K",

   DisableRayfieldPrompts = false,
   DisableBuildWarnings = false,

   ConfigurationSaving = {
      Enabled = true,
      FolderName = "Forged Hub",
      FileName = "ForgedHubForsaken"
   },

   Discord = {
      Enabled = false,
   },

   KeySystem = false
})

-- TABS
local WelcomeTab = Window:CreateTab("Welcome!", "hand")
local PlayerTab = Window:CreateTab("Player", "person-standing")
local ESPTab = Window:CreateTab("ESP", "eye")
local AimbotTab = Window:CreateTab("Aimbot", "locate")
local VisualTab = Window:CreateTab("Visual", "monitor-smartphone")

-- WELCOME TAB
local WelcomeLabel = WelcomeTab:CreateLabel("Welcome to Forged Hub!\nCurrent version: v1.0.0", "info")

-- ESP TAB
-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- PLAYER
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- STORAGE
local ESPObjects = {}
local ESPEnabled = {}

-- SETTINGS
local ESPSettings = {
    RefreshRate = 0.1,
    DisplayName = true,
    DisplayHealth = true,
    DisplayGeneratorProgress = true,
    DisplayDistance = true,
}

local ESPHeartbeatConnection

--------------------------------------------------
-- UTILITIES
--------------------------------------------------

local function GetDistance(Part)
    if not Part then return 0 end
    return math.floor((Camera.CFrame.Position - Part.Position).Magnitude)
end

local function ClearESP(Key)
    if ESPObjects[Key] then
        for _, Object in pairs(ESPObjects[Key]) do
            if Object and Object.Parent then
                Object:Destroy()
            end
        end
        ESPObjects[Key] = nil
    end
end

local function CreateHighlight(Parent, Color)
    local HighlightInstance = Instance.new("Highlight")
    HighlightInstance.FillColor = Color
    HighlightInstance.OutlineColor = Color
    HighlightInstance.FillTransparency = 0.6
    HighlightInstance.OutlineTransparency = 0
    HighlightInstance.Parent = Parent
    return HighlightInstance
end

local function CreateBillboard(Parent)
    local Billboard = Instance.new("BillboardGui")
    Billboard.Size = UDim2.fromScale(0, 0)
    Billboard.AlwaysOnTop = true
    Billboard.StudsOffset = Vector3.new(0, 3, 0)
    Billboard.Parent = Parent

    local TextLabel = Instance.new("TextLabel")
    TextLabel.Size = UDim2.fromScale(1, 1)
    TextLabel.BackgroundTransparency = 1
    TextLabel.TextColor3 = Color3.new(1, 1, 1)
    TextLabel.TextStrokeTransparency = 0
    TextLabel.TextScaled = true
    TextLabel.Font = Enum.Font.SourceSansBold
    TextLabel.Parent = Billboard

    return Billboard, TextLabel
end

--------------------------------------------------
-- ESP LOOP
--------------------------------------------------

local function StartESPLoop()
    if ESPHeartbeatConnection then return end

    ESPHeartbeatConnection = RunService.Heartbeat:Connect(function()
        task.wait(ESPSettings.RefreshRate)
        for _, Update in pairs(ESPEnabled) do
            Update()
        end
    end)
end

local ESPCommands = {}

--------------------------------------------------
-- KILLER / SURVIVOR SHARED
--------------------------------------------------

local function CharacterESP(Folder, Key, Color)
    ClearESP(Key)
    ESPObjects[Key] = {}

    for _, Model in pairs(Folder:GetChildren()) do
        if Model:GetAttribute("Username") ~= LocalPlayer.Name then
            local Root = Model:FindFirstChild("HumanoidRootPart")
            local Humanoid = Model:FindFirstChildOfClass("Humanoid")
            if Root and Humanoid then
                local Highlight = CreateHighlight(Model, Color)
                local Billboard, Label = CreateBillboard(Root)

                Label.Text = ""
                if ESPSettings.DisplayName then
                    Label.Text ..= Model.Name .. " (" .. Model:GetAttribute("Username") .. ")\n"
                end
                if ESPSettings.DisplayHealth then
                    Label.Text ..= "Health: " .. math.floor(Humanoid.Health) .. "/" .. Humanoid.MaxHealth .. "\n"
                end
                if ESPSettings.DisplayDistance then
                    Label.Text ..= GetDistance(Root) .. " studs away"
                end

                table.insert(ESPObjects[Key], Highlight)
                table.insert(ESPObjects[Key], Billboard)
            end
        end
    end
end

function ESPCommands.KillerESP(Value)
    if not Value then ClearESP("KillerESP") return end
    CharacterESP(workspace.Players.Killers, "KillerESP", Color3.fromRGB(255,255,255))
end

function ESPCommands.SurvivorESP(Value)
    if not Value then ClearESP("SurvivorESP") return end
    CharacterESP(workspace.Players.Survivors, "SurvivorESP", Color3.fromRGB(0,85,127))
end

--------------------------------------------------
-- GENERATOR ESP
--------------------------------------------------

function ESPCommands.GeneratorESP(Value)
    ClearESP("GeneratorESP")
    if not Value then return end

    ESPObjects.GeneratorESP = {}

    for _, Model in pairs(workspace.Map.Ingame.Map:GetDescendants()) do
        if Model:IsA("Model") and (Model.Name == "Generator" or Model.Name == "FakeGenerator") then
            local Root = Model.PrimaryPart or Model:FindFirstChildWhichIsA("BasePart")
            local Progress = Model:FindFirstChild("Progress")

            if Root then
                local Color =
                    Model.Name == "FakeGenerator" and Color3.fromRGB(85,0,127)
                    or (Progress and Progress.Value >= 100 and Color3.fromRGB(85,255,0))
                    or Color3.fromRGB(0,85,127)

                local Highlight = CreateHighlight(Model, Color)
                local Billboard, Label = CreateBillboard(Root)

                Label.Text = Model.Name
                if ESPSettings.DisplayGeneratorProgress and Progress then
                    Label.Text ..= "\nProgress: " .. math.floor(Progress.Value) .. "%"
                end
                if ESPSettings.DisplayDistance then
                    Label.Text ..= "\n" .. GetDistance(Root) .. " studs away"
                end

                table.insert(ESPObjects.GeneratorESP, Highlight)
                table.insert(ESPObjects.GeneratorESP, Billboard)
            end
        end
    end
end

--------------------------------------------------
-- ITEM ESP
--------------------------------------------------

function ESPCommands.ItemESP(Value)
    ClearESP("ItemESP")
    if not Value then return end

    ESPObjects.ItemESP = {}

    for _, Tool in pairs(workspace.Map.Ingame.Map:GetDescendants()) do
        if Tool:IsA("Tool") then
            local Handle = Tool:FindFirstChildWhichIsA("BasePart")
            if Handle then
                local Highlight = CreateHighlight(Tool, Color3.fromRGB(255,255,255))
                local Billboard, Label = CreateBillboard(Handle)

                Label.Text = Tool.Name
                if ESPSettings.DisplayDistance then
                    Label.Text ..= "\n" .. GetDistance(Handle) .. " studs away"
                end

                table.insert(ESPObjects.ItemESP, Highlight)
                table.insert(ESPObjects.ItemESP, Billboard)
            end
        end
    end
end

--------------------------------------------------
-- SIMPLE HIGHLIGHT ESP
--------------------------------------------------

local function SimpleHighlightESP(Value, Key, Names, Color)
    ClearESP(Key)
    if not Value then return end

    ESPObjects[Key] = {}

    for _, Model in pairs(workspace.Map.Ingame:GetDescendants()) do
        if Model:IsA("Model") then
            for _, Name in pairs(Names) do
                if string.find(Model.Name, Name) then
                    table.insert(ESPObjects[Key], CreateHighlight(Model, Color))
                end
            end
        end
    end
end

function ESPCommands.BuildermanBuilds(Value)
    SimpleHighlightESP(Value, "BuildermanBuilds", {"BuildermanSentry","BuildermanDispenser"}, Color3.fromRGB(255,255,0))
end

function ESPCommands.TaphTrapsESP(Value)
    SimpleHighlightESP(Value, "TaphTrapsESP", {"SubspaceTripmine","TaphTripwire"}, Color3.fromRGB(255,0,255))
end

--------------------------------------------------
-- MINIONS + BILLBOARD
--------------------------------------------------

local function MinionESP(Value, Key, NameMatch, Color, LabelText)
    ClearESP(Key)
    if not Value then return end

    ESPObjects[Key] = {}

    for _, Model in pairs(workspace.Map.Ingame:GetDescendants()) do
        if Model:IsA("Model") and string.find(Model.Name, NameMatch) then
            local Root = Model.PrimaryPart or Model:FindFirstChildWhichIsA("BasePart")
            if Root then
                local Highlight = CreateHighlight(Model, Color)
                local Billboard, Label = CreateBillboard(Root)

                Label.Text = LabelText
                if ESPSettings.DisplayDistance then
                    Label.Text ..= "\n" .. GetDistance(Root) .. " studs away"
                end

                table.insert(ESPObjects[Key], Highlight)
                table.insert(ESPObjects[Key], Billboard)
            end
        end
    end
end

function ESPCommands.OneXMinionESP(Value)
    MinionESP(Value, "1xMinion", "Zombie", Color3.fromRGB(0,170,0), "1x1x1x1 Minion")
end

function ESPCommands.C00lKiddMinionESP(Value)
    MinionESP(Value, "c00lkiddMinion", "PizzaDeliveryRig", Color3.fromRGB(255,85,0), "c00lkidd Minion")
end

--------------------------------------------------
-- BILLBOARD ONLY
--------------------------------------------------

local function BillboardOnlyESP(Value, Key, NameMatch, LabelText)
    ClearESP(Key)
    if not Value then return end

    ESPObjects[Key] = {}

    for _, Model in pairs(workspace.Map.Ingame:GetDescendants()) do
        if Model:IsA("Model") and string.find(Model.Name, NameMatch) then
            local Root = Model.PrimaryPart or Model:FindFirstChildWhichIsA("BasePart")
            if Root then
                local Billboard, Label = CreateBillboard(Root)
                Label.Text = LabelText .. "\n" .. GetDistance(Root) .. " studs away"
                table.insert(ESPObjects[Key], Billboard)
            end
        end
    end
end

function ESPCommands.VeeronicaGraffitiESP(Value)
    BillboardOnlyESP(Value, "VeeronicaGraffiti", "Spray", "Graffiti")
end

function ESPCommands.JohnDoeDigitalFootprintESP(Value)
    BillboardOnlyESP(Value, "JohnDoeFootprint", "Shadow", "John Doe Digital Footprint")
end

--------------------------------------------------
-- SETTINGS
--------------------------------------------------

function ESPCommands.SetRefreshRate(Value) ESPSettings.RefreshRate = Value end
function ESPCommands.SetDisplayName(Value) ESPSettings.DisplayName = Value end
function ESPCommands.SetDisplayHealth(Value) ESPSettings.DisplayHealth = Value end
function ESPCommands.SetDisplayGeneratorProgress(Value) ESPSettings.DisplayGeneratorProgress = Value end
function ESPCommands.SetDisplayDistance(Value) ESPSettings.DisplayDistance = Value end


-- ESP TAB
local MainESPSection = ESPTab:CreateSection("Main ESP")

local KillerESPToggle = ESPTab:CreateToggle({
   Name = "Killer ESP",
   CurrentValue = false,
   Flag = "KillerESP",
   Callback = function(Value)
      ESPEnabled.KillerESP = Value and function()
         ESPCommands.KillerESP(true)
      end or nil

      ESPCommands.KillerESP(Value)
      StartESPLoop()
   end,
})

local SurvivorESPToggle = ESPTab:CreateToggle({
   Name = "Survivor ESP",
   CurrentValue = false,
   Flag = "SurvivorESP",
   Callback = function(Value)
      ESPEnabled.SurvivorESP = Value and function()
         ESPCommands.SurvivorESP(true)
      end or nil

      ESPCommands.SurvivorESP(Value)
      StartESPLoop()
   end,
})

local GeneratorESPToggle = ESPTab:CreateToggle({
   Name = "Generator ESP",
   CurrentValue = false,
   Flag = "GeneratorESP",
   Callback = function(Value)
      ESPEnabled.GeneratorESP = Value and function()
         ESPCommands.GeneratorESP(true)
      end or nil

      ESPCommands.GeneratorESP(Value)
      StartESPLoop()
   end,
})

local ItemESPToggle = ESPTab:CreateToggle({
   Name = "Item ESP",
   CurrentValue = false,
   Flag = "ItemESP",
   Callback = function(Value)
      ESPEnabled.ItemESP = Value and function()
         ESPCommands.ItemESP(true)
      end or nil

      ESPCommands.ItemESP(Value)
      StartESPLoop()
   end,
})

--------------------------------------------------

local OtherESPSection = ESPTab:CreateSection("Other ESP")

local BuildermanBuildsESPToggle = ESPTab:CreateToggle({
   Name = "Builderman Builds",
   CurrentValue = false,
   Flag = "BuildermanBuilds",
   Callback = function(Value)
      ESPEnabled.BuildermanBuilds = Value and function()
         ESPCommands.BuildermanBuilds(true)
      end or nil

      ESPCommands.BuildermanBuilds(Value)
      StartESPLoop()
   end,
})

local TaphTrapsESPToggle = ESPTab:CreateToggle({
   Name = "Taph Traps ESP",
   CurrentValue = false,
   Flag = "TaphTrapsESP",
   Callback = function(Value)
      ESPEnabled.TaphTrapsESP = Value and function()
         ESPCommands.TaphTrapsESP(true)
      end or nil

      ESPCommands.TaphTrapsESP(Value)
      StartESPLoop()
   end,
})

local OnexOnexOnexOneMinionESPToggle = ESPTab:CreateToggle({
   Name = "1x1x1x1 Minion ESP",
   CurrentValue = false,
   Flag = "1x1x1x1MinionESP",
   Callback = function(Value)
      ESPEnabled.OneXMinionESP = Value and function()
         ESPCommands.OneXMinionESP(true)
      end or nil

      ESPCommands.OneXMinionESP(Value)
      StartESPLoop()
   end,
})

local c00lkiddMinionESPToggle = ESPTab:CreateToggle({
   Name = "c00lkidd Minion ESP",
   CurrentValue = false,
   Flag = "c00lkiddMinionESP",
   Callback = function(Value)
      ESPEnabled.C00lKiddMinionESP = Value and function()
         ESPCommands.C00lKiddMinionESP(true)
      end or nil

      ESPCommands.C00lKiddMinionESP(Value)
      StartESPLoop()
   end,
})

local VeeronicaGraffitiESPToggle = ESPTab:CreateToggle({
   Name = "Veeronica Graffiti ESP",
   CurrentValue = false,
   Flag = "VeeronicaGraffitiESP",
   Callback = function(Value)
      ESPEnabled.VeeronicaGraffitiESP = Value and function()
         ESPCommands.VeeronicaGraffitiESP(true)
      end or nil

      ESPCommands.VeeronicaGraffitiESP(Value)
      StartESPLoop()
   end,
})

local JohnDoeDigitalFootprintESPToggle = ESPTab:CreateToggle({
   Name = "John Doe Digital Footprint ESP",
   CurrentValue = false,
   Flag = "JohnDoeDigitalFootprintESP",
   Callback = function(Value)
      ESPEnabled.JohnDoeDigitalFootprintESP = Value and function()
         ESPCommands.JohnDoeDigitalFootprintESP(true)
      end or nil

      ESPCommands.JohnDoeDigitalFootprintESP(Value)
      StartESPLoop()
   end,
})

--------------------------------------------------

local ESPSettingsSection = ESPTab:CreateSection("ESP Settings")

local ESPRefreshRateSlider = ESPTab:CreateSlider({
   Name = "ESP Refresh Rate",
   Range = {0.1, 1},
   Increment = 0.05,
   Suffix = "s",
   CurrentValue = 0.1,
   Flag = "ESPRefreshRate",
   Callback = function(Value)
      ESPCommands.SetRefreshRate(Value)
   end,
})

local DisplayNameToggle = ESPTab:CreateToggle({
   Name = "Display Name",
   CurrentValue = true,
   Flag = "DisplayName",
   Callback = function(Value)
      ESPCommands.SetDisplayName(Value)
   end,
})

local DisplayHealthToggle = ESPTab:CreateToggle({
   Name = "Display Health",
   CurrentValue = true,
   Flag = "DisplayHealth",
   Callback = function(Value)
      ESPCommands.SetDisplayHealth(Value)
   end,
})

local DisplayGeneratorProgressToggle = ESPTab:CreateToggle({
   Name = "Display Generator Progress",
   CurrentValue = true,
   Flag = "DisplayGeneratorProgress",
   Callback = function(Value)
      ESPCommands.SetDisplayGeneratorProgress(Value)
   end,
})

local DisplayDistanceToggle = ESPTab:CreateToggle({
   Name = "Display Distance",
   CurrentValue = true,
   Flag = "DisplayDistance",
   Callback = function(Value)
      ESPCommands.SetDisplayDistance(Value)
   end,
})
