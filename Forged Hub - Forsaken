-- BOOT RAYFIELD
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "Forged Hub - Forsaken",
   Icon = "anvil",
   LoadingTitle = "Forged Hub",
   LoadingSubtitle = "Loading...",
   ShowText = "Forged Hub",
   Theme = "DarkBlue",

   ToggleUIKeybind = "K",

   DisableRayfieldPrompts = false,
   DisableBuildWarnings = false,

   ConfigurationSaving = {
      Enabled = true,
      FolderName = "Forged Hub",
      FileName = "ForgedHubForsaken"
   },

   Discord = {
      Enabled = false,
   },

   KeySystem = false
})

-- TABS
local WelcomeTab = Window:CreateTab("Welcome!", "hand")
local PlayerTab = Window:CreateTab("Player", "person-standing")
local ESPTab = Window:CreateTab("ESP", "eye")
local AimbotTab = Window:CreateTab("Aimbot", "locate")
local VisualTab = Window:CreateTab("Visual", "monitor-smartphone")

-- WELCOME TAB
local WelcomeLabel = WelcomeTab:CreateLabel("Welcome to Forged Hub!\nCurrent version: v1.0.0", "info")

-- ESP TAB
--// SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

--// PLAYER
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

--// STATE
local ESPObjects = {}
local ESPEnabled = {}

--// SETTINGS
local ESPSettings = {
    RefreshRate = 0.1,
    DisplayName = true,
    DisplayHealth = true,
    DisplayGeneratorProgress = true,
    DisplayDistance = true,
}

--------------------------------------------------
--// UTILITIES
--------------------------------------------------

local function GetRoot(Model)
    return Model:FindFirstChild("HumanoidRootPart")
        or Model.PrimaryPart
        or Model:FindFirstChildWhichIsA("BasePart", true)
end

local function GetDistance(Part)
    return math.floor((Camera.CFrame.Position - Part.Position).Magnitude)
end

local function CreateHighlight(Model, Name, Color)
    local Highlight = Instance.new("Highlight")
    Highlight.Name = Name
    Highlight.FillColor = Color
    Highlight.OutlineColor = Color
    Highlight.FillTransparency = 0.6
    Highlight.OutlineTransparency = 0
    Highlight.Parent = Model
    return Highlight
end

local function CreateBillboard(Root)
    local Billboard = Instance.new("BillboardGui")
    Billboard.Size = UDim2.fromOffset(220, 60)
    Billboard.AlwaysOnTop = true
    Billboard.StudsOffset = Vector3.new(0, 3, 0)
    Billboard.Parent = Root

    local Label = Instance.new("TextLabel")
    Label.Size = UDim2.fromScale(1, 1)
    Label.BackgroundTransparency = 1
    Label.TextColor3 = Color3.new(1, 1, 1)
    Label.TextStrokeTransparency = 0
    Label.TextScaled = true
    Label.Font = Enum.Font.SourceSansBold
    Label.Parent = Billboard

    return Billboard, Label
end

--------------------------------------------------
--// GENERIC ESP ENGINE
--------------------------------------------------

local function UpdateESP(Key, Models, BuildText, GetColor)
    ESPObjects[Key] = ESPObjects[Key] or {}

    local Alive = {}

    for _, Model in pairs(Models) do
        local Root = GetRoot(Model)
        if Root then
            Alive[Model] = true
            local Entry = ESPObjects[Key][Model]

            if not Entry then
                local Highlight = CreateHighlight(Model, Key .. "Highlight", GetColor(Model))
                local Billboard, Label = CreateBillboard(Root)

                ESPObjects[Key][Model] = {
                    Highlight = Highlight,
                    Billboard = Billboard,
                    Label = Label
                }

                Entry = ESPObjects[Key][Model]
            end

            local Color = GetColor(Model)
            Entry.Highlight.FillColor = Color
            Entry.Highlight.OutlineColor = Color
            Entry.Label.Text = BuildText(Model, Root)
        end
    end

    for Model, Entry in pairs(ESPObjects[Key]) do
        if not Alive[Model] then
            Entry.Highlight:Destroy()
            Entry.Billboard:Destroy()
            ESPObjects[Key][Model] = nil
        end
    end
end

--------------------------------------------------
--// ESP COMMANDS
--------------------------------------------------

local ESPCommands = {}

-- KILLERS
function ESPCommands.KillerESP()
    local Models = workspace.Players.Killers:GetChildren()

    UpdateESP(
        "KillerESP",
        Models,
        function(Model, Root)
            if Model:GetAttribute("Username") == LocalPlayer.Name then
                return ""
            end

            local Humanoid = Model:FindFirstChildOfClass("Humanoid")
            if not Humanoid then return "" end

            local Text = ""
            if ESPSettings.DisplayName then
                Text ..= Model.Name .. " (" .. Model:GetAttribute("Username") .. ")\n"
            end
            if ESPSettings.DisplayHealth then
                Text ..= "Health: " .. math.floor(Humanoid.Health) .. "/" .. Humanoid.MaxHealth .. "\n"
            end
            if ESPSettings.DisplayDistance then
                Text ..= GetDistance(Root) .. " studs away"
            end

            return Text
        end,
        function()
            return Color3.fromRGB(255, 255, 255)
        end
    )
end

-- SURVIVORS
function ESPCommands.SurvivorESP()
    local Models = workspace.Players.Survivors:GetChildren()

    UpdateESP(
        "SurvivorESP",
        Models,
        function(Model, Root)
            if Model:GetAttribute("Username") == LocalPlayer.Name then
                return ""
            end

            local Humanoid = Model:FindFirstChildOfClass("Humanoid")
            if not Humanoid then return "" end

            local Text = ""
            if ESPSettings.DisplayName then
                Text ..= Model.Name .. " (" .. Model:GetAttribute("Username") .. ")\n"
            end
            if ESPSettings.DisplayHealth then
                Text ..= "Health: " .. math.floor(Humanoid.Health) .. "/" .. Humanoid.MaxHealth .. "\n"
            end
            if ESPSettings.DisplayDistance then
                Text ..= GetDistance(Root) .. " studs away"
            end

            return Text
        end,
        function()
            return Color3.fromRGB(0, 85, 127)
        end
    )
end

-- GENERATORS
function ESPCommands.GeneratorESP()
    local Models = {}

    for _, Obj in pairs(workspace.Map.Ingame.Map:GetDescendants()) do
        if Obj:IsA("Model") and (Obj.Name == "Generator" or Obj.Name == "FakeGenerator") then
            table.insert(Models, Obj)
        end
    end

    UpdateESP(
        "GeneratorESP",
        Models,
        function(Model, Root)
            local Text = Model.Name
            local Progress = Model:FindFirstChild("Progress")

            if ESPSettings.DisplayGeneratorProgress and Progress then
                Text ..= "\nProgress: " .. math.floor(Progress.Value) .. "%"
            end
            if ESPSettings.DisplayDistance then
                Text ..= "\n" .. GetDistance(Root) .. " studs away"
            end

            return Text
        end,
        function(Model)
            local Progress = Model:FindFirstChild("Progress")

            if Model.Name == "FakeGenerator" then
                return Color3.fromRGB(85, 0, 127)
            end
            if Progress and Progress.Value >= 100 then
                return Color3.fromRGB(85, 255, 0)
            end
            return Color3.fromRGB(0, 85, 127)
        end
    )
end

--------------------------------------------------
--// SETTINGS
--------------------------------------------------

function ESPCommands.SetRefreshRate(Value) ESPSettings.RefreshRate = Value end
function ESPCommands.SetDisplayName(Value) ESPSettings.DisplayName = Value end
function ESPCommands.SetDisplayHealth(Value) ESPSettings.DisplayHealth = Value end
function ESPCommands.SetDisplayGeneratorProgress(Value) ESPSettings.DisplayGeneratorProgress = Value end
function ESPCommands.SetDisplayDistance(Value) ESPSettings.DisplayDistance = Value end

--------------------------------------------------
--// LOOP
--------------------------------------------------

RunService.Heartbeat:Connect(function()
    task.wait(ESPSettings.RefreshRate)
    for _, Update in pairs(ESPEnabled) do
        Update()
    end
end)



-- ESP TAB
local MainESPSection = ESPTab:CreateSection("Main ESP")

local KillerESPToggle = ESPTab:CreateToggle({
   Name = "Killer ESP",
   CurrentValue = false,
   Flag = "KillerESP",
   Callback = function(Value)
      ESPEnabled.KillerESP = Value and function()
         ESPCommands.KillerESP(true)
      end or nil

      ESPCommands.KillerESP(Value)
      StartESPLoop()
   end,
})

local SurvivorESPToggle = ESPTab:CreateToggle({
   Name = "Survivor ESP",
   CurrentValue = false,
   Flag = "SurvivorESP",
   Callback = function(Value)
      ESPEnabled.SurvivorESP = Value and function()
         ESPCommands.SurvivorESP(true)
      end or nil

      ESPCommands.SurvivorESP(Value)
      StartESPLoop()
   end,
})

local GeneratorESPToggle = ESPTab:CreateToggle({
   Name = "Generator ESP",
   CurrentValue = false,
   Flag = "GeneratorESP",
   Callback = function(Value)
      ESPEnabled.GeneratorESP = Value and function()
         ESPCommands.GeneratorESP(true)
      end or nil

      ESPCommands.GeneratorESP(Value)
      StartESPLoop()
   end,
})

local ItemESPToggle = ESPTab:CreateToggle({
   Name = "Item ESP",
   CurrentValue = false,
   Flag = "ItemESP",
   Callback = function(Value)
      ESPEnabled.ItemESP = Value and function()
         ESPCommands.ItemESP(true)
      end or nil

      ESPCommands.ItemESP(Value)
      StartESPLoop()
   end,
})

--------------------------------------------------

local OtherESPSection = ESPTab:CreateSection("Other ESP")

local BuildermanBuildsESPToggle = ESPTab:CreateToggle({
   Name = "Builderman Builds",
   CurrentValue = false,
   Flag = "BuildermanBuilds",
   Callback = function(Value)
      ESPEnabled.BuildermanBuilds = Value and function()
         ESPCommands.BuildermanBuilds(true)
      end or nil

      ESPCommands.BuildermanBuilds(Value)
      StartESPLoop()
   end,
})

local TaphTrapsESPToggle = ESPTab:CreateToggle({
   Name = "Taph Traps ESP",
   CurrentValue = false,
   Flag = "TaphTrapsESP",
   Callback = function(Value)
      ESPEnabled.TaphTrapsESP = Value and function()
         ESPCommands.TaphTrapsESP(true)
      end or nil

      ESPCommands.TaphTrapsESP(Value)
      StartESPLoop()
   end,
})

local OnexOnexOnexOneMinionESPToggle = ESPTab:CreateToggle({
   Name = "1x1x1x1 Minion ESP",
   CurrentValue = false,
   Flag = "1x1x1x1MinionESP",
   Callback = function(Value)
      ESPEnabled.OneXMinionESP = Value and function()
         ESPCommands.OneXMinionESP(true)
      end or nil

      ESPCommands.OneXMinionESP(Value)
      StartESPLoop()
   end,
})

local c00lkiddMinionESPToggle = ESPTab:CreateToggle({
   Name = "c00lkidd Minion ESP",
   CurrentValue = false,
   Flag = "c00lkiddMinionESP",
   Callback = function(Value)
      ESPEnabled.C00lKiddMinionESP = Value and function()
         ESPCommands.C00lKiddMinionESP(true)
      end or nil

      ESPCommands.C00lKiddMinionESP(Value)
      StartESPLoop()
   end,
})

local VeeronicaGraffitiESPToggle = ESPTab:CreateToggle({
   Name = "Veeronica Graffiti ESP",
   CurrentValue = false,
   Flag = "VeeronicaGraffitiESP",
   Callback = function(Value)
      ESPEnabled.VeeronicaGraffitiESP = Value and function()
         ESPCommands.VeeronicaGraffitiESP(true)
      end or nil

      ESPCommands.VeeronicaGraffitiESP(Value)
      StartESPLoop()
   end,
})

local JohnDoeDigitalFootprintESPToggle = ESPTab:CreateToggle({
   Name = "John Doe Digital Footprint ESP",
   CurrentValue = false,
   Flag = "JohnDoeDigitalFootprintESP",
   Callback = function(Value)
      ESPEnabled.JohnDoeDigitalFootprintESP = Value and function()
         ESPCommands.JohnDoeDigitalFootprintESP(true)
      end or nil

      ESPCommands.JohnDoeDigitalFootprintESP(Value)
      StartESPLoop()
   end,
})

--------------------------------------------------

local ESPSettingsSection = ESPTab:CreateSection("ESP Settings")

local ESPRefreshRateSlider = ESPTab:CreateSlider({
   Name = "ESP Refresh Rate",
   Range = {0.1, 1},
   Increment = 0.05,
   Suffix = "s",
   CurrentValue = 0.1,
   Flag = "ESPRefreshRate",
   Callback = function(Value)
      ESPCommands.SetRefreshRate(Value)
   end,
})

local DisplayNameToggle = ESPTab:CreateToggle({
   Name = "Display Name",
   CurrentValue = true,
   Flag = "DisplayName",
   Callback = function(Value)
      ESPCommands.SetDisplayName(Value)
   end,
})

local DisplayHealthToggle = ESPTab:CreateToggle({
   Name = "Display Health",
   CurrentValue = true,
   Flag = "DisplayHealth",
   Callback = function(Value)
      ESPCommands.SetDisplayHealth(Value)
   end,
})

local DisplayGeneratorProgressToggle = ESPTab:CreateToggle({
   Name = "Display Generator Progress",
   CurrentValue = true,
   Flag = "DisplayGeneratorProgress",
   Callback = function(Value)
      ESPCommands.SetDisplayGeneratorProgress(Value)
   end,
})

local DisplayDistanceToggle = ESPTab:CreateToggle({
   Name = "Display Distance",
   CurrentValue = true,
   Flag = "DisplayDistance",
   Callback = function(Value)
      ESPCommands.SetDisplayDistance(Value)
   end,
})
